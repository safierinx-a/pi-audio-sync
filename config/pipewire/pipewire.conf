# PipeWire configuration for Pi Audio Sync
context.properties = {
    link.max-buffers = 16
    core.daemon = true
    core.name = pipewire-0
    mem.allow-mlock = true
    support.dbus = true
    log.level = 2
}

context.spa-libs = {
    audio.convert.* = audioconvert/libspa-audioconvert
    api.alsa.* = alsa/libspa-alsa
    api.v4l2.* = v4l2/libspa-v4l2
    api.bluez5.* = bluez5/libspa-bluez5
    support.* = support/libspa-support
}

# Explicitly set module search path
context.module-path = [
    /usr/lib/pipewire-0.3
    /usr/lib/$(uname -m)-linux-gnu/pipewire-0.3
]

# Load modules in specific order
context.modules = [
    # Protocol
    { name = libpipewire-module-protocol-native }
    
    # Core functionality
    { name = libpipewire-module-client-node }
    { name = libpipewire-module-client-device }
    { name = libpipewire-module-adapter }
    { name = libpipewire-module-metadata }
    
    # Session management
    { name = libpipewire-module-session-manager }
    
    # Additional modules
    { name = libpipewire-module-spa-device-factory }
    { name = libpipewire-module-spa-node-factory }
]

context.objects = [
    { factory = spa-node-factory 
      args = { 
        factory.name = support.node.driver
        node.name = Dummy-Driver
        node.group = pipewire.dummy
        priority.driver = 20000
      }
    }
]

context.exec = [
    { path = "/usr/bin/wireplumber" args = "" }
]

# Bluetooth settings
bluez5.properties = {
    bluez5.enable-sbc-xq = true
    bluez5.enable-msbc = true
    bluez5.enable-hw-volume = true
    bluez5.headset-roles = [ hsp_hs hfp_ag ]
    bluez5.codecs = [ sbc_xq ldac aac ]
    bluez5.msbc-support = true
    bluez5.msbc-quality = high
    bluez5.auto-connect = true
}

# Monitor rules for ALSA
monitor.alsa.rules = [
    {
        matches = [
            { device.name = "~alsa_card.*" }
        ]
        actions = {
            update-props = {
                api.alsa.soft-mixer = true
            }
        }
    }
]

stream.properties = {
    node.latency = 1024/48000
    resample.quality = 7
    channelmix.normalize = false
    channelmix.mix-lfe = false
}

alsa.properties = {
    alsa.buffer-size = 4096
    alsa.period-size = 1024
    alsa.period-num = 4
}

# PipeWire-Pulse configuration
pulse.cmd = [
    { cmd = "load-module" args = "module-native-protocol-tcp listen=0.0.0.0" }
] 